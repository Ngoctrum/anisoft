name: üî∑ CENTOS SSH - NGROK

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '6h'
        type: choice
        options:
        - '1h'
        - '2h'
        - '3h'
        - '4h'
        - '5h'
        - '6h'
      config:
        description: '‚öôÔ∏è C·∫•u h√¨nh VPS'
        required: false
        default: 'basic'
        type: choice
        options:
        - 'basic'
        - 'standard'
        - 'premium'

jobs:
  CentOS-SSH-Ngrok:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          echo "üî∑ CENTOS SSH SERVER - NGROK"
          echo "‚ö° Public Access via Ngrok"
          echo "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}"

      - name: üîß C·∫§U H√åNH SSH
        run: |
          echo "üõ†Ô∏è ƒêANG C·∫§U H√åNH SSH"
          sudo apt-get update -qq
          sudo apt-get install -y openssh-server curl
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart ssh
          echo "‚úÖ SSH Server ƒë√£ s·∫µn s√†ng"

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N
        run: |
          echo "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N"
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9' | head -c 10)
          sudo useradd -m -s /bin/bash aistv-ngrok
          echo "aistv-ngrok:$PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo aistv-ngrok
          echo "aistv-ngrok ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/aistv-ngrok
          echo "$PASSWORD" > /tmp/ssh_password.txt
          echo "‚úÖ T√†i kho·∫£n s·∫µn s√†ng"

      - name: üåê THI·∫æT L·∫¨P NGROK
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          echo "üåê ƒêANG THI·∫æT L·∫¨P NGROK"
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt-get update && sudo apt-get install -y ngrok
          ngrok authtoken $NGROK_AUTH_TOKEN
          ngrok tcp 22 --log=stdout > /tmp/ngrok.log 2>&1 &
          sleep 10
          NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | grep -oP '"public_url":"tcp://\K[^"]+' | head -1)
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          echo "‚úÖ Ngrok URL: $NGROK_URL"

      - name: üì§ G·ª¨I TH√îNG TIN
        run: |
          PASSWORD=$(cat /tmp/ssh_password.txt)
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          curl -X POST "https://wxqxriwodkgzpzqaxigp.supabase.co/functions/v1/update-rdp-info" \
            -H "apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4cXhyaXdvZGtnenB6cWF4aWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzk0MDcsImV4cCI6MjA3OTQ1NTQwN30.u8piIXHELUvdN9klNTFhnBFrD0lzwMg0EMPcrz1Wfh8" \
            -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4cXhyaXdvZGtnenB6cWF4aWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzk0MDcsImV4cCI6MjA3OTQ1NTQwN30.u8piIXHELUvdN9klNTFhnBFrD0lzwMg0EMPcrz1Wfh8" \
            -H "Content-Type: application/json" \
            -d "{\"repoName\":\"$REPO_NAME\",\"ngrokUrl\":\"$NGROK_URL\",\"rdpUser\":\"aistv-ngrok\",\"rdpPassword\":\"$PASSWORD\",\"osType\":\"centos\"}" \
            || echo "‚ö†Ô∏è Warning"

      - name: ‚è≥ DUY TR√å PHI√äN
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          HOURS=${DURATION%h}
          MINUTES=$((HOURS * 60))
          echo "üîÑ Duy tr√¨ $HOURS gi·ªù..."
          for ((i=MINUTES; i>0; i--)); do
            echo -ne "\r‚è±Ô∏è C√≤n: $((i/60))h $((i%60))m   "
            sleep 60
          done
