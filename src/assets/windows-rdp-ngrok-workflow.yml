name: ğŸš€ WINDOWS RDP - NGROK

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Windows-RDP-Ngrok:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸªŸ WINDOWS RDP SERVER - NGROK" -ForegroundColor Yellow
          Write-Host "âš¡ Public Access via Ngrok" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""

      - name: ğŸ”§ Cáº¤U HÃŒNH RDP
        run: |
          Write-Host "ğŸ› ï¸ ÄANG Cáº¤U HÃŒNH RDP" -ForegroundColor Yellow
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          netsh advfirewall firewall add rule name="RDP-Ngrok" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          Set-Service -Name TermService -StartupType Automatic
          Start-Service -Name TermService
          Write-Host "âœ… RDP Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh" -ForegroundColor Green

      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N
        run: |
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N" -ForegroundColor Yellow
          
          function New-Password {
              $chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789'
              -join ((1..10) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          }
          
          $password = New-Password
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          
          Remove-LocalUser -Name "AISTV-NGROK" -ErrorAction SilentlyContinue
          New-LocalUser -Name "AISTV-NGROK" -Password $securePass -AccountNeverExpires -Description "AI STV Ngrok Account"
          Set-LocalUser -Name "AISTV-NGROK" -PasswordNeverExpires $true
          
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-NGROK"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-NGROK"
          Enable-LocalUser -Name "AISTV-NGROK"
          
          echo "RDP_USER=AISTV-NGROK" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          echo "$password" > $env:TEMP\rdp_password.txt
          
          Write-Host "âœ… TÃ i khoáº£n: AISTV-NGROK Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      - name: ğŸŒ THIáº¾T Láº¬P NGROK TUNNEL
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P NGROK TUNNEL" -ForegroundColor Yellow
          
          # Download Ngrok
          $ngrokZip = "$env:TEMP\ngrok.zip"
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile $ngrokZip
          Expand-Archive -Path $ngrokZip -DestinationPath "$env:TEMP\ngrok" -Force
          Remove-Item $ngrokZip -Force
          Write-Host "â”‚ âœ… ÄÃ£ táº£i Ngrok" -ForegroundColor Green
          
          # Authenticate Ngrok
          & "$env:TEMP\ngrok\ngrok.exe" authtoken $env:NGROK_AUTH_TOKEN
          Write-Host "â”‚ âœ… ÄÃ£ xÃ¡c thá»±c Ngrok" -ForegroundColor Green
          
          # Start Ngrok tunnel trong background
          Start-Process -FilePath "$env:TEMP\ngrok\ngrok.exe" -ArgumentList "tcp", "3389", "--log=stdout" -NoNewWindow -RedirectStandardOutput "$env:TEMP\ngrok.log"
          Write-Host "â”‚ âœ… ÄÃ£ khá»Ÿi Ä‘á»™ng Ngrok tunnel" -ForegroundColor Green
          
          # Chá» Ngrok khá»Ÿi Ä‘á»™ng
          Start-Sleep -Seconds 10
          
          # Láº¥y public URL tá»« Ngrok API
          $ngrokUrl = $null
          for($i=0; $i -lt 20; $i++) {
              try {
                  $response = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
                  $tunnel = $response.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1
                  if ($tunnel -and $tunnel.public_url) {
                      $ngrokUrl = $tunnel.public_url -replace 'tcp://', ''
                      echo "NGROK_URL=$ngrokUrl" >> $env:GITHUB_ENV
                      Write-Host "âœ… Ngrok URL: $ngrokUrl" -ForegroundColor Green
                      break
                  }
              } catch {
                  # Retry
              }
              Start-Sleep -Seconds 3
          }
          
          if (-not $ngrokUrl) {
              Write-Host "âŒ KhÃ´ng thá»ƒ láº¥y Ngrok URL" -ForegroundColor Red
              exit 1
          }

      - name: ğŸ“¤ Gá»¬I THÃ”NG TIN Vá»€ WEBSITE
        run: |
          Write-Host "ğŸ“¤ ÄANG Gá»¬I THÃ”NG TIN Vá»€ WEBSITE..." -ForegroundColor Yellow
          
          $password = Get-Content $env:TEMP\rdp_password.txt
          $repoName = "${{ github.repository }}".Split('/')[-1]
          
          $body = @{
              repoName = $repoName
              ngrokUrl = $env:NGROK_URL
              rdpUser = "AISTV-NGROK"
              rdpPassword = $password
          } | ConvertTo-Json
          
          try {
              Invoke-RestMethod -Uri "https://wxqxriwodkgzpzqaxigp.supabase.co/functions/v1/update-rdp-info" -Method POST -Body $body -ContentType "application/json" -Headers @{
                  "apikey" = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4cXhyaXdvZGtnenB6cWF4aWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzk0MDcsImV4cCI6MjA3OTQ1NTQwN30.u8piIXHELUvdN9klNTFhnBFrD0lzwMg0EMPcrz1Wfh8"
                  "Authorization" = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind4cXhyaXdvZGtnenB6cWF4aWdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4Nzk0MDcsImV4cCI6MjA3OTQ1NTQwN30.u8piIXHELUvdN9klNTFhnBFrD0lzwMg0EMPcrz1Wfh8"
              }
              Write-Host "âœ… ÄÃ£ gá»­i thÃ´ng tin vá» website!" -ForegroundColor Green
          } catch {
              Write-Host "âš ï¸ Lá»—i gá»­i thÃ´ng tin nhÆ°ng VPS váº«n hoáº¡t Ä‘á»™ng" -ForegroundColor Yellow
          }

      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $password = Get-Content $env:TEMP\rdp_password.txt
          
          Write-Host ""
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚       ğŸ‰ NGROK RDP ÄÃƒ Sáº´N SÃ€NG!          â”‚" -ForegroundColor Cyan
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ  URL: $env:NGROK_URL" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤  User: AISTV-NGROK" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Password: $password" -ForegroundColor White
          Write-Host "â”‚ ğŸŒ  Truy cáº­p tá»« báº¥t ká»³ Ä‘Ã¢u!" -ForegroundColor White
          Write-Host "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸ’¡  HÆ°á»›ng dáº«n:                            â”‚" -ForegroundColor Cyan
          Write-Host "â”‚   1. Má»Ÿ Remote Desktop Connection         â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   2. Nháº­p: $env:NGROK_URL                 â”‚" -ForegroundColor Yellow
          Write-Host "â”‚   3. User: AISTV-NGROK | Password: trÃªn  â”‚" -ForegroundColor Yellow
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan

      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60 }
              "3h" { $totalMinutes = 180 }
              "5h40m" { $totalMinutes = 340 }
          }
          
          Write-Host "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN..." -ForegroundColor Yellow
          Write-Host "ğŸ’ Windows RDP via Ngrok" -ForegroundColor Green
          Write-Host "ğŸ”— Káº¿t ná»‘i: $env:NGROK_URL" -ForegroundColor Green
          
          for($i=$totalMinutes; $i -gt 0; $i--) {
              $hours = [math]::Floor($i / 60)
              $mins = $i % 60
              Write-Host "`râ±ï¸ CÃ²n láº¡i: ${hours}h ${mins}m   " -NoNewline -ForegroundColor Blue
              Start-Sleep -Seconds 60
          }
          
          Write-Host ""
          Write-Host "ğŸ¯ ÄÃƒ Háº¾T THá»œI GIAN - Tá»° Äá»˜NG Dá»ªNG!" -ForegroundColor Green
